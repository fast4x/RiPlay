name: Build and Release Signed APKs

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch latest commits
        if: github.event_name == 'workflow_dispatch'
        run: |
          git fetch origin main
          git reset --hard origin/main
          echo "âœ… Synced to latest commit on main"

      - name: Validate version format and check if tag exists
        if: github.event_name == 'workflow_dispatch'
        run: |
          VERSION="${{ github.event.inputs.version }}"
          
          # Validazione formato
          if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid version format! Use v1.0.0"
            exit 1
          fi
          
          # Controlla se il tag esiste
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "âŒ Tag $VERSION already exists!"
            exit 1
          fi
          
          echo "âœ… Version $VERSION is valid and new"

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Decode keystore from secrets to temp directory
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          mkdir -p ${{ runner.temp }}/keystore
          echo "$KEYSTORE_BASE64" | base64 -d > ${{ runner.temp }}/keystore/RiPlayKeystore.jks
          chmod 600 ${{ runner.temp }}/keystore/RiPlayKeystore.jks

      - name: Build Release APK - Full Flavor
        env:
          SIGNING_KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          SIGNING_STORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          SIGNING_STORE_FILE: ${{ runner.temp }}/keystore/RiPlayKeystore.jks
        run: |
          ./gradlew :composeApp:assembleFullRelease -PBUILD_VARIANT=full

      - name: Build Release APK - FOSS Flavor
        env:
          SIGNING_KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          SIGNING_STORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          SIGNING_STORE_FILE: ${{ runner.temp }}/keystore/RiPlayKeystore.jks
        run: |
          ./gradlew :composeApp:assembleFossRelease -PBUILD_VARIANT=foss

      - name: Collect APK files
        run: |
          mkdir -p release-apks
          find composeApp -name "*.apk" -path "*/release/*" -exec cp {} release-apks/ \;
          ls -lah release-apks/

      - name: Generate Changelog
        id: changelog
        run: |
          CURRENT_TAG="${{ github.event.inputs.version }}"
          
          if [ -z "$CURRENT_TAG" ]; then
            CURRENT_TAG="${{ github.ref_name }}"
          fi
          
          PREVIOUS_TAG=$(git tag --sort=-version:refname --list "v*" --merged ${CURRENT_TAG} | grep -v "^${CURRENT_TAG}$" | head -1)
          
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "âš ï¸  No previous tag found - showing all commits"
            git log --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" --reverse | head -20 > /tmp/changelog.txt
          else
            echo "ðŸ“‹ Changes between $PREVIOUS_TAG and $CURRENT_TAG"
            git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" > /tmp/changelog.txt
          fi
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/changelog.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release Notes
        id: release_notes
        run: |
          CURRENT_TAG="${{ github.event.inputs.version }}"
          
          if [ -z "$CURRENT_TAG" ]; then
            CURRENT_TAG="${{ github.ref_name }}"
          fi
          
          RELEASE_DATE=$(date +'%Y-%m-%d')
          COMMIT_HASH=$(git rev-parse --short HEAD)
          
          cat > /tmp/release_notes.md << EOF
          ## ðŸ“± RiPlay ${CURRENT_TAG} - Released ${RELEASE_DATE}

          ### ðŸ“‹ What's Changed
          ${{ steps.changelog.outputs.changelog }}
          
          ### ðŸ“¦ Downloads
          - **Full Flavor** (All features)
          - **FOSS Flavor** (Open source only)
          
          ### âœ¨ Build Information
          - **Build Date**: ${RELEASE_DATE}
          - **Git Commit**: \`${COMMIT_HASH}\`
          - **Java Version**: 21
          
          **Thank you for using RiPlay!** ðŸŽµ
          EOF
          
          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-apks/*.apk
          body: ${{ steps.release_notes.outputs.release_notes }}
          draft: false
          prerelease: false
          tag_name: ${{ github.event.inputs.version || github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Clean up sensitive files
        if: always()
        run: |
          rm -rf ${{ runner.temp }}/keystore
          echo "âœ… Keystore removed from temporary directory"

      - name: Build Summary
        if: success()
        run: |
          echo "âœ… Release completed successfully!"
          echo "ðŸ“¦ APK Files:"
          ls -lh release-apks/
