name: Build and Release Signed APKs

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog generation

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Decode keystore from secrets to temp directory
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          mkdir -p ${{ runner.temp }}/keystore
          echo "$KEYSTORE_BASE64" | base64 -d > ${{ runner.temp }}/keystore/RiPlayKeystore.jks
          chmod 600 ${{ runner.temp }}/keystore/RiPlayKeystore.jks

      - name: Build Release APK - Full Flavor
        env:
          SIGNING_KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          SIGNING_STORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          SIGNING_STORE_FILE: ${{ runner.temp }}/keystore/RiPlayKeystore.jks
        run: |
          ./gradlew :composeApp:assembleFullRelease -PBUILD_VARIANT=full

      - name: Build Release APK - FOSS Flavor
        env:
          SIGNING_KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          SIGNING_STORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          SIGNING_STORE_FILE: ${{ runner.temp }}/keystore/RiPlayKeystore.jks
        run: |
          ./gradlew :composeApp:assembleFossRelease -PBUILD_VARIANT=foss

      - name: Collect APK files
        run: |
          mkdir -p release-apks
          find composeApp -name "*.apk" -path "*/release/*" -exec cp {} release-apks/ \;
          ls -lah release-apks/

      - name: Generate Changelog
        id: changelog
        run: |
          CURRENT_TAG=$(git describe --tags --abbrev=0)
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 ${CURRENT_TAG}^ 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            # First release - get all commits
            CHANGELOG=$(git log --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" --reverse | head -20)
          else
            # Get commits between two tags
            CHANGELOG=$(git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" --reverse)
          fi
          
          # Handle multiline changelog
          CHANGELOG="${CHANGELOG//'%'/'%25'}"
          CHANGELOG="${CHANGELOG//$'\n'/'%0A'}"
          CHANGELOG="${CHANGELOG//$'\r'/'%0D'}"
          echo "changelog=${CHANGELOG}" >> $GITHUB_OUTPUT

      - name: Create Release Notes
        id: release_notes
        run: |
          CURRENT_TAG=$(git describe --tags --abbrev=0)
          RELEASE_DATE=$(date +'%Y-%m-%d')
          
          # Leggi il changelog generato nel step precedente
          CHANGELOG="${{ steps.changelog.outputs.changelog }}"
          
          # Decodifica i %0A in vere newline
          CHANGELOG=$(echo -e "${CHANGELOG//\\%0A/\\n}")
          
          cat > /tmp/release_notes.md << 'EOF'
          ## ðŸ“± RiPlay ${{ github.ref_name }} - Released $RELEASE_DATE

          ### ðŸ“‹ What's Changed
          $CHANGELOG
          
          ### ðŸ“¦ Downloads
          - **Full Flavor** (All features)
          - **FOSS Flavor** (Open source only)
          
          ### âœ¨ Build Information
          - **Build Date**: $RELEASE_DATE
          - **Git Commit**: `$(git rev-parse --short HEAD)`
          - **Java Version**: 21
          
          **Thank you for using RiPlay!** ðŸŽµ
          EOF
          
          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          cat /tmp/release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-apks/*.apk
          body: ${{ steps.release_notes.outputs.release_notes }}
          draft: false
          prerelease: false
          tag_name: ${{ github.ref_name || github.event.inputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Clean up sensitive files
        if: always()
        run: |
          rm -rf ${{ runner.temp }}/keystore
          echo "âœ… Keystore removed from temporary directory"

      - name: Build Summary
        if: success()
        run: |
          echo "âœ… Release completed successfully!"
          echo "ðŸ“¦ APK Files:"
          ls -lh release-apks/
